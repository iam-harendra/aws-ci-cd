Authenticating with public key "Imported-Openssh-Key"
    ┌──────────────────────────────────────────────────────────────────────┐
    │                 • MobaXterm Personal Edition v23.5 •                 │
    │               (SSH client, X server and network tools)               │
    │                                                                      │
    │ ⮞ SSH session to ubuntu@15.206.165.176                               │
    │   • Direct SSH      :  ✓                                             │
    │   • SSH compression :  ✓                                             │
    │   • SSH-browser     :  ✓                                             │
    │   • X11-forwarding  :  ✓  (remote display is forwarded through SSH)  │
    │                                                                      │
    │ ⮞ For more info, ctrl+click on help or visit our website.            │
    └──────────────────────────────────────────────────────────────────────┘

Welcome to Ubuntu 22.04.3 LTS (GNU/Linux 6.2.0-1017-aws x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sun Feb 11 07:30:18 UTC 2024

  System load:  0.0146484375      Processes:             102
  Usage of /:   20.6% of 7.57GB   Users logged in:       0
  Memory usage: 20%               IPv4 address for eth0: 172.31.10.193
  Swap usage:   0%

Expanded Security Maintenance for Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: sudo pro status


The list of available updates is more than a week old.
To check for new updates run: sudo apt update


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

/usr/bin/xauth:  file /home/ubuntu/.Xauthority does not exist
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

ubuntu@ip-172-31-10-193:~$
ubuntu@ip-172-31-10-193:~$
ubuntu@ip-172-31-10-193:~$ sudo su
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# ls -lrth
total 0
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# sudo apt update
Hit:1 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy InRelease
Get:2 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates InRelease [119 kB]
Get:3 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-backports InRelease [109 kB]
Get:4 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe amd64 Packages [14.1 MB]
Get:5 http://security.ubuntu.com/ubuntu jammy-security InRelease [110 kB]
Get:6 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe Translation-en [5652 kB]
Get:7 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe amd64 c-n-f Metadata [286 kB]
Get:8 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/multiverse amd64 Packages [217 kB]
Get:9 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/multiverse Translation-en [112 kB]
Get:10 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/multiverse amd64 c-n-f Metadata [8372 B]
Get:11 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main amd64 Packages [1366 kB]
Get:12 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main Translation-en [272 kB]
Get:13 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/restricted amd64 Packages [1412 kB]
Get:14 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/restricted Translation-en [233 kB]
Get:15 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/universe amd64 Packages [1044 kB]
Get:16 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/universe Translation-en [235 kB]
Get:17 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/universe amd64 c-n-f Metadata [22.1 kB]
Get:18 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/multiverse amd64 Packages [42.1 kB]
Get:19 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/multiverse Translation-en [10.1 kB]
Get:20 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/multiverse amd64 c-n-f Metadata [472 B]
Get:21 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-backports/main amd64 Packages [41.7 kB]
Get:22 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-backports/main Translation-en [10.5 kB]
Get:23 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-backports/main amd64 c-n-f Metadata [388 B]
Get:24 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-backports/restricted amd64 c-n-f Metadata [116 B]
Get:25 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-backports/universe amd64 Packages [24.3 kB]
Get:26 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-backports/universe Translation-en [16.5 kB]
Get:27 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-backports/universe amd64 c-n-f Metadata [644 B]
Get:28 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-backports/multiverse amd64 c-n-f Metadata [116 B]
Get:29 http://security.ubuntu.com/ubuntu jammy-security/main amd64 Packages [1142 kB]
Get:30 http://security.ubuntu.com/ubuntu jammy-security/main Translation-en [211 kB]
Get:31 http://security.ubuntu.com/ubuntu jammy-security/restricted amd64 Packages [1366 kB]
Get:32 http://security.ubuntu.com/ubuntu jammy-security/restricted Translation-en [224 kB]
Get:33 http://security.ubuntu.com/ubuntu jammy-security/universe amd64 Packages [839 kB]
Get:34 http://security.ubuntu.com/ubuntu jammy-security/universe Translation-en [160 kB]
Get:35 http://security.ubuntu.com/ubuntu jammy-security/universe amd64 c-n-f Metadata [16.8 kB]
Get:36 http://security.ubuntu.com/ubuntu jammy-security/multiverse amd64 Packages [37.1 kB]
Get:37 http://security.ubuntu.com/ubuntu jammy-security/multiverse Translation-en [7476 B]
Get:38 http://security.ubuntu.com/ubuntu jammy-security/multiverse amd64 c-n-f Metadata [260 B]
Fetched 29.4 MB in 6s (5325 kB/s)
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
60 packages can be upgraded. Run 'apt list --upgradable' to see them.
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# sudo apt install ruby-full
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  fonts-lato javascript-common libgmp-dev libgmpxx4ldbl libjs-jquery libruby3.0 rake ri ruby ruby-dev ruby-net-telnet ruby-rubygems ruby-webrick ruby-xmlrpc
  ruby3.0 ruby3.0-dev ruby3.0-doc rubygems-integration unzip zip
Suggested packages:
  apache2 | lighttpd | httpd gmp-doc libgmp10-doc libmpfr-dev bundler
The following NEW packages will be installed:
  fonts-lato javascript-common libgmp-dev libgmpxx4ldbl libjs-jquery libruby3.0 rake ri ruby ruby-dev ruby-full ruby-net-telnet ruby-rubygems ruby-webrick
  ruby-xmlrpc ruby3.0 ruby3.0-dev ruby3.0-doc rubygems-integration unzip zip
0 upgraded, 21 newly installed, 0 to remove and 60 not upgraded.
Need to get 11.4 MB of archives.
After this operation, 59.7 MB of additional disk space will be used.
Do you want to continue? [Y/n] y
Get:1 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 fonts-lato all 2.0-2.1 [2696 kB]
Get:2 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 javascript-common all 11+nmu1 [5936 B]
Get:3 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 libgmpxx4ldbl amd64 2:6.2.1+dfsg-3ubuntu1 [9580 B]
Get:4 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 libgmp-dev amd64 2:6.2.1+dfsg-3ubuntu1 [337 kB]
Get:5 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 libjs-jquery all 3.6.0+dfsg+~3.5.13-1 [321 kB]
Get:6 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 rubygems-integration all 1.18 [5336 B]
Get:7 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main amd64 ruby3.0 amd64 3.0.2-7ubuntu2.4 [50.1 kB]
Get:8 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 ruby-rubygems all 3.3.5-2 [228 kB]
Get:9 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 ruby amd64 1:3.0~exp1 [5100 B]
Get:10 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 rake all 13.0.6-2 [61.7 kB]
Get:11 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 ruby-net-telnet all 0.1.1-2 [12.6 kB]
Get:12 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe amd64 ruby-webrick all 1.7.0-3 [51.8 kB]
Get:13 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main amd64 ruby-xmlrpc all 0.3.2-1ubuntu0.1 [24.9 kB]
Get:14 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main amd64 libruby3.0 amd64 3.0.2-7ubuntu2.4 [5113 kB]
Get:15 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main amd64 ruby3.0-doc all 3.0.2-7ubuntu2.4 [1855 kB]
Get:16 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe amd64 ri all 1:3.0~exp1 [4206 B]
Get:17 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main amd64 ruby3.0-dev amd64 3.0.2-7ubuntu2.4 [242 kB]
Get:18 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 ruby-dev amd64 1:3.0~exp1 [4328 B]
Get:19 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe amd64 ruby-full all 1:3.0~exp1 [2582 B]
Get:20 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main amd64 unzip amd64 6.0-26ubuntu3.1 [174 kB]
Get:21 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 zip amd64 3.0-12build2 [176 kB]
Fetched 11.4 MB in 2s (6394 kB/s)
Selecting previously unselected package fonts-lato.
(Reading database ... 64799 files and directories currently installed.)
Preparing to unpack .../00-fonts-lato_2.0-2.1_all.deb ...
Unpacking fonts-lato (2.0-2.1) ...
Selecting previously unselected package javascript-common.
Preparing to unpack .../01-javascript-common_11+nmu1_all.deb ...
Unpacking javascript-common (11+nmu1) ...
Selecting previously unselected package libgmpxx4ldbl:amd64.
Preparing to unpack .../02-libgmpxx4ldbl_2%3a6.2.1+dfsg-3ubuntu1_amd64.deb ...
Unpacking libgmpxx4ldbl:amd64 (2:6.2.1+dfsg-3ubuntu1) ...
Selecting previously unselected package libgmp-dev:amd64.
Preparing to unpack .../03-libgmp-dev_2%3a6.2.1+dfsg-3ubuntu1_amd64.deb ...
Unpacking libgmp-dev:amd64 (2:6.2.1+dfsg-3ubuntu1) ...
Selecting previously unselected package libjs-jquery.
Preparing to unpack .../04-libjs-jquery_3.6.0+dfsg+~3.5.13-1_all.deb ...
Unpacking libjs-jquery (3.6.0+dfsg+~3.5.13-1) ...
Selecting previously unselected package rubygems-integration.
Preparing to unpack .../05-rubygems-integration_1.18_all.deb ...
Unpacking rubygems-integration (1.18) ...
Selecting previously unselected package ruby3.0.
Preparing to unpack .../06-ruby3.0_3.0.2-7ubuntu2.4_amd64.deb ...
Unpacking ruby3.0 (3.0.2-7ubuntu2.4) ...
Selecting previously unselected package ruby-rubygems.
Preparing to unpack .../07-ruby-rubygems_3.3.5-2_all.deb ...
Unpacking ruby-rubygems (3.3.5-2) ...
Selecting previously unselected package ruby.
Preparing to unpack .../08-ruby_1%3a3.0~exp1_amd64.deb ...
Unpacking ruby (1:3.0~exp1) ...
Selecting previously unselected package rake.
Preparing to unpack .../09-rake_13.0.6-2_all.deb ...
Unpacking rake (13.0.6-2) ...
Selecting previously unselected package ruby-net-telnet.
Preparing to unpack .../10-ruby-net-telnet_0.1.1-2_all.deb ...
Unpacking ruby-net-telnet (0.1.1-2) ...
Selecting previously unselected package ruby-webrick.
Preparing to unpack .../11-ruby-webrick_1.7.0-3_all.deb ...
Unpacking ruby-webrick (1.7.0-3) ...
Selecting previously unselected package ruby-xmlrpc.
Preparing to unpack .../12-ruby-xmlrpc_0.3.2-1ubuntu0.1_all.deb ...
Unpacking ruby-xmlrpc (0.3.2-1ubuntu0.1) ...
Selecting previously unselected package libruby3.0:amd64.
Preparing to unpack .../13-libruby3.0_3.0.2-7ubuntu2.4_amd64.deb ...
Unpacking libruby3.0:amd64 (3.0.2-7ubuntu2.4) ...
Selecting previously unselected package ruby3.0-doc.
Preparing to unpack .../14-ruby3.0-doc_3.0.2-7ubuntu2.4_all.deb ...
Unpacking ruby3.0-doc (3.0.2-7ubuntu2.4) ...
Selecting previously unselected package ri.
Preparing to unpack .../15-ri_1%3a3.0~exp1_all.deb ...
Unpacking ri (1:3.0~exp1) ...
Selecting previously unselected package ruby3.0-dev:amd64.
Preparing to unpack .../16-ruby3.0-dev_3.0.2-7ubuntu2.4_amd64.deb ...
Unpacking ruby3.0-dev:amd64 (3.0.2-7ubuntu2.4) ...
Selecting previously unselected package ruby-dev:amd64.
Preparing to unpack .../17-ruby-dev_1%3a3.0~exp1_amd64.deb ...
Unpacking ruby-dev:amd64 (1:3.0~exp1) ...
Selecting previously unselected package ruby-full.
Preparing to unpack .../18-ruby-full_1%3a3.0~exp1_all.deb ...
Unpacking ruby-full (1:3.0~exp1) ...
Selecting previously unselected package unzip.
Preparing to unpack .../19-unzip_6.0-26ubuntu3.1_amd64.deb ...
Unpacking unzip (6.0-26ubuntu3.1) ...
Selecting previously unselected package zip.
Preparing to unpack .../20-zip_3.0-12build2_amd64.deb ...
Unpacking zip (3.0-12build2) ...
Setting up javascript-common (11+nmu1) ...
Setting up fonts-lato (2.0-2.1) ...
Setting up unzip (6.0-26ubuntu3.1) ...
Setting up rubygems-integration (1.18) ...
Setting up zip (3.0-12build2) ...
Setting up libgmpxx4ldbl:amd64 (2:6.2.1+dfsg-3ubuntu1) ...
Setting up ruby-net-telnet (0.1.1-2) ...
Setting up ruby-webrick (1.7.0-3) ...
Setting up ruby3.0-doc (3.0.2-7ubuntu2.4) ...
Setting up libjs-jquery (3.6.0+dfsg+~3.5.13-1) ...
Setting up ruby-xmlrpc (0.3.2-1ubuntu0.1) ...
Setting up libgmp-dev:amd64 (2:6.2.1+dfsg-3ubuntu1) ...
Setting up rake (13.0.6-2) ...
Setting up libruby3.0:amd64 (3.0.2-7ubuntu2.4) ...
Setting up ruby-rubygems (3.3.5-2) ...
Setting up ruby3.0-dev:amd64 (3.0.2-7ubuntu2.4) ...
Setting up ruby3.0 (3.0.2-7ubuntu2.4) ...
Setting up ruby-dev:amd64 (1:3.0~exp1) ...
Setting up ri (1:3.0~exp1) ...
Setting up ruby (1:3.0~exp1) ...
Setting up ruby-full (1:3.0~exp1) ...
Processing triggers for libc-bin (2.35-0ubuntu3.4) ...
Processing triggers for man-db (2.10.2-1) ...
Scanning processes...
Scanning linux images...

Running kernel seems to be up-to-date.

No services need to be restarted.

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.

root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# sudo apt install wget
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
wget is already the newest version (1.21.2-2ubuntu1).
wget set to manually installed.
0 upgraded, 0 newly installed, 0 to remove and 60 not upgraded.
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# cd /home/ubuntu
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# wget https://aws-codedeploy-ap-south-1.s3.ap-south-1.amazonaws.com/latest/install
--2024-02-11 07:36:30--  https://aws-codedeploy-ap-south-1.s3.ap-south-1.amazonaws.com/latest/install
Resolving aws-codedeploy-ap-south-1.s3.ap-south-1.amazonaws.com (aws-codedeploy-ap-south-1.s3.ap-south-1.amazonaws.com)... 16.12.40.6, 52.219.156.30, 52.219.158.198, ...
Connecting to aws-codedeploy-ap-south-1.s3.ap-south-1.amazonaws.com (aws-codedeploy-ap-south-1.s3.ap-south-1.amazonaws.com)|16.12.40.6|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 17892 (17K) []
Saving to: ‘install’

install                                 100%[=============================================================================>]  17.47K  --.-KB/s    in 0s

2024-02-11 07:36:31 (59.4 MB/s) - ‘install’ saved [17892/17892]

root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# chmod +x ./install
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# sudo ./install auto
I, [2024-02-11T07:41:05.566923 #2166]  INFO -- : Starting Ruby version check.
I, [2024-02-11T07:41:05.567461 #2166]  INFO -- : Starting update check.
I, [2024-02-11T07:41:05.567731 #2166]  INFO -- : Attempting to automatically detect supported package manager type for system...
W, [2024-02-11T07:41:05.577138 #2166]  WARN -- : apt-get found but no gdebi. Installing gdebi with `apt-get install gdebi-core -y`...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following NEW packages will be installed:
  gdebi-core
0 upgraded, 1 newly installed, 0 to remove and 60 not upgraded.
Need to get 133 kB of archives.
After this operation, 876 kB of additional disk space will be used.
Get:1 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe amd64 gdebi-core all 0.9.5.7+nmu6 [133 kB]
Fetched 133 kB in 1s (235 kB/s)
Selecting previously unselected package gdebi-core.
(Reading database ... 81218 files and directories currently installed.)
Preparing to unpack .../gdebi-core_0.9.5.7+nmu6_all.deb ...
Unpacking gdebi-core (0.9.5.7+nmu6) ...
Setting up gdebi-core (0.9.5.7+nmu6) ...
Processing triggers for man-db (2.10.2-1) ...
Scanning processes...
Scanning linux images...

Running kernel seems to be up-to-date.

No services need to be restarted.

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.
I, [2024-02-11T07:41:10.704778 #2166]  INFO -- : Checking AWS_REGION environment variable for region information...
I, [2024-02-11T07:41:10.705159 #2166]  INFO -- : Checking EC2 metadata service for region information...
I, [2024-02-11T07:41:10.728599 #2166]  INFO -- : Checking AWS_DOMAIN environment variable for domain information...
I, [2024-02-11T07:41:10.728935 #2166]  INFO -- : Checking EC2 metadata service for domain information...
I, [2024-02-11T07:41:10.735193 #2166]  INFO -- : Downloading version file from bucket aws-codedeploy-ap-south-1 and key latest/LATEST_VERSION...
I, [2024-02-11T07:41:10.735592 #2166]  INFO -- : Endpoint: https://aws-codedeploy-ap-south-1.s3.ap-south-1.amazonaws.com/latest/LATEST_VERSION
dpkg-query: package 'codedeploy-agent' is not installed and no information is available
Use dpkg --info (= dpkg-deb --info) to examine archive files.
I, [2024-02-11T07:41:10.776756 #2166]  INFO -- : Running version No running version
I, [2024-02-11T07:41:10.777242 #2166]  INFO -- : Downloading package from bucket aws-codedeploy-ap-south-1 and key releases/codedeploy-agent_1.6.0-49_all.deb...
I, [2024-02-11T07:41:10.777528 #2166]  INFO -- : Endpoint: https://aws-codedeploy-ap-south-1.s3.ap-south-1.amazonaws.com/releases/codedeploy-agent_1.6.0-49_all.deb
I, [2024-02-11T07:41:10.825811 #2166]  INFO -- : Executing `/usr/bin/gdebi -n -o Dpkg::Options::=--force-confdef -o Dkpg::Options::=--force-confold /tmp/codedeploy-agent_1.6.0-49_all.tmp-20240211-2166-kybvf9.deb`...
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
Reading state information... Done
Selecting previously unselected package codedeploy-agent.
(Reading database ... 81290 files and directories currently installed.)
Preparing to unpack .../codedeploy-agent_1.6.0-49_all.tmp-20240211-2166-kybvf9.deb ...
Unpacking codedeploy-agent (1.6.0-49) ...
Setting up codedeploy-agent (1.6.0-49) ...
codedeploy-agent.service is not a native service, redirecting to systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install enable codedeploy-agent
I, [2024-02-11T07:41:16.022414 #2166]  INFO -- : Update check complete.
I, [2024-02-11T07:41:16.022782 #2166]  INFO -- : Stopping updater.
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# systemctl status codedeploy-agent
● codedeploy-agent.service - LSB: AWS CodeDeploy Host Agent
     Loaded: loaded (/etc/init.d/codedeploy-agent; generated)
     Active: active (running) since Sun 2024-02-11 07:41:15 UTC; 9s ago
       Docs: man:systemd-sysv-generator(8)
    Process: 2432 ExecStart=/etc/init.d/codedeploy-agent start (code=exited, status=0/SUCCESS)
      Tasks: 2 (limit: 1121)
     Memory: 58.5M
        CPU: 1.064s
     CGroup: /system.slice/codedeploy-agent.service
             ├─2438 "codedeploy-agent: master 2438" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" ""
             └─2440 "codedeploy-agent: InstanceAgent::Plugins::CodeDeployPlugin::CommandPoller of master 2438"

Feb 11 07:41:15 ip-172-31-10-193 systemd[1]: Starting LSB: AWS CodeDeploy Host Agent...
Feb 11 07:41:15 ip-172-31-10-193 codedeploy-agent[2432]: Starting codedeploy-agent:
Feb 11 07:41:15 ip-172-31-10-193 systemd[1]: Started LSB: AWS CodeDeploy Host Agent.
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# systemctl start codedeploy-agent
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# systemctl restart codedeploy-agent
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# systemctl status codedeploy-agent
● codedeploy-agent.service - LSB: AWS CodeDeploy Host Agent
     Loaded: loaded (/etc/init.d/codedeploy-agent; generated)
     Active: active (running) since Sun 2024-02-11 07:42:04 UTC; 1min 59s ago
       Docs: man:systemd-sysv-generator(8)
    Process: 2457 ExecStart=/etc/init.d/codedeploy-agent start (code=exited, status=0/SUCCESS)
      Tasks: 4 (limit: 1121)
     Memory: 59.4M
        CPU: 1.108s
     CGroup: /system.slice/codedeploy-agent.service
             ├─2464 "codedeploy-agent: master 2464" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" "" ""
             └─2466 "codedeploy-agent: InstanceAgent::Plugins::CodeDeployPlugin::CommandPoller of master 2464"

Feb 11 07:42:03 ip-172-31-10-193 systemd[1]: Stopped LSB: AWS CodeDeploy Host Agent.
Feb 11 07:42:03 ip-172-31-10-193 systemd[1]: codedeploy-agent.service: Consumed 1.532s CPU time.
Feb 11 07:42:03 ip-172-31-10-193 systemd[1]: Starting LSB: AWS CodeDeploy Host Agent...
Feb 11 07:42:04 ip-172-31-10-193 codedeploy-agent[2457]: Starting codedeploy-agent:
Feb 11 07:42:04 ip-172-31-10-193 systemd[1]: Started LSB: AWS CodeDeploy Host Agent.
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# sudo apt install docker.io -y
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  bridge-utils containerd dns-root-data dnsmasq-base pigz runc ubuntu-fan
Suggested packages:
  ifupdown aufs-tools cgroupfs-mount | cgroup-lite debootstrap docker-doc rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils containerd dns-root-data dnsmasq-base docker.io pigz runc ubuntu-fan
0 upgraded, 8 newly installed, 0 to remove and 60 not upgraded.
Need to get 69.8 MB of archives.
After this operation, 267 MB of additional disk space will be used.
Get:1 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe amd64 pigz amd64 2.6-1 [63.6 kB]
Get:2 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 bridge-utils amd64 1.7-1ubuntu3 [34.4 kB]
Get:3 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main amd64 runc amd64 1.1.7-0ubuntu1~22.04.2 [4267 kB]
Get:4 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main amd64 containerd amd64 1.7.2-0ubuntu1~22.04.1 [36.0 MB]
Get:5 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/main amd64 dns-root-data all 2021011101 [5256 B]
Get:6 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/main amd64 dnsmasq-base amd64 2.86-1.1ubuntu0.5 [355 kB]
Get:7 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy-updates/universe amd64 docker.io amd64 24.0.5-0ubuntu1~22.04.1 [28.9 MB]
Get:8 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe amd64 ubuntu-fan all 0.12.16 [35.2 kB]
Fetched 69.8 MB in 1s (59.2 MB/s)
Preconfiguring packages ...
Selecting previously unselected package pigz.
(Reading database ... 83226 files and directories currently installed.)
Preparing to unpack .../0-pigz_2.6-1_amd64.deb ...
Unpacking pigz (2.6-1) ...
Selecting previously unselected package bridge-utils.
Preparing to unpack .../1-bridge-utils_1.7-1ubuntu3_amd64.deb ...
Unpacking bridge-utils (1.7-1ubuntu3) ...
Selecting previously unselected package runc.
Preparing to unpack .../2-runc_1.1.7-0ubuntu1~22.04.2_amd64.deb ...
Unpacking runc (1.1.7-0ubuntu1~22.04.2) ...
Selecting previously unselected package containerd.
Preparing to unpack .../3-containerd_1.7.2-0ubuntu1~22.04.1_amd64.deb ...
Unpacking containerd (1.7.2-0ubuntu1~22.04.1) ...
Selecting previously unselected package dns-root-data.
Preparing to unpack .../4-dns-root-data_2021011101_all.deb ...
Unpacking dns-root-data (2021011101) ...
Selecting previously unselected package dnsmasq-base.
Preparing to unpack .../5-dnsmasq-base_2.86-1.1ubuntu0.5_amd64.deb ...
Unpacking dnsmasq-base (2.86-1.1ubuntu0.5) ...
Selecting previously unselected package docker.io.
Preparing to unpack .../6-docker.io_24.0.5-0ubuntu1~22.04.1_amd64.deb ...
Unpacking docker.io (24.0.5-0ubuntu1~22.04.1) ...
Selecting previously unselected package ubuntu-fan.
Preparing to unpack .../7-ubuntu-fan_0.12.16_all.deb ...
Unpacking ubuntu-fan (0.12.16) ...
Setting up dnsmasq-base (2.86-1.1ubuntu0.5) ...
Setting up runc (1.1.7-0ubuntu1~22.04.2) ...
Setting up dns-root-data (2021011101) ...
Setting up bridge-utils (1.7-1ubuntu3) ...
Setting up pigz (2.6-1) ...
Setting up containerd (1.7.2-0ubuntu1~22.04.1) ...
Created symlink /etc/systemd/system/multi-user.target.wants/containerd.service → /lib/systemd/system/containerd.service.
Setting up ubuntu-fan (0.12.16) ...
Created symlink /etc/systemd/system/multi-user.target.wants/ubuntu-fan.service → /lib/systemd/system/ubuntu-fan.service.
Setting up docker.io (24.0.5-0ubuntu1~22.04.1) ...
Adding group `docker' (GID 122) ...
Done.
Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /lib/systemd/system/docker.service.
Created symlink /etc/systemd/system/sockets.target.wants/docker.socket → /lib/systemd/system/docker.socket.
Processing triggers for dbus (1.12.20-2ubuntu4.1) ...
Processing triggers for man-db (2.10.2-1) ...
Scanning processes...
Scanning linux images...

Running kernel seems to be up-to-date.

No services need to be restarted.

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# sudo apt install docker -y
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  wmdocker
The following NEW packages will be installed:
  docker wmdocker
0 upgraded, 2 newly installed, 0 to remove and 60 not upgraded.
Need to get 14.3 kB of archives.
After this operation, 58.4 kB of additional disk space will be used.
Get:1 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe amd64 wmdocker amd64 1.5-2 [13.0 kB]
Get:2 http://ap-south-1.ec2.archive.ubuntu.com/ubuntu jammy/universe amd64 docker all 1.5-2 [1316 B]
Fetched 14.3 kB in 1s (17.5 kB/s)
Selecting previously unselected package wmdocker.
(Reading database ... 83590 files and directories currently installed.)
Preparing to unpack .../wmdocker_1.5-2_amd64.deb ...
Unpacking wmdocker (1.5-2) ...
Selecting previously unselected package docker.
Preparing to unpack .../archives/docker_1.5-2_all.deb ...
Unpacking docker (1.5-2) ...
Setting up wmdocker (1.5-2) ...
Setting up docker (1.5-2) ...
Processing triggers for man-db (2.10.2-1) ...
Scanning processes...
Scanning linux images...

Running kernel seems to be up-to-date.

No services need to be restarted.

No containers need to be restarted.

No user sessions are running outdated binaries.

No VM guests are running outdated hypervisor (qemu) binaries on this host.
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# ls -lrth
total 20K
-rwxr-xr-x 1 root root 18K Dec 13 06:20 install
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu#
root@ip-172-31-10-193:/home/ubuntu# cat install
#!/usr/bin/env ruby

##################################################################
# This part of the code might be running on Ruby versions other
# than 2.0. Testing on multiple Ruby versions is required for
# changes to this part of the code.
##################################################################

class LoggerWrapper
  def initialize(loggers)
    @loggers = loggers
  end

  def debug(message)
    @loggers.each do |logger|
      logger.debug(message)
    end
  end

  def error(message)
    @loggers.each do |logger|
      logger.error(message)
    end
  end

  def info(message)
    @loggers.each do |logger|
      logger.info(message)
    end
  end

  def level(message)
    @loggers.each do |logger|
      logger.level = message
    end
  end

  def warn(message)
    @loggers.each do |logger|
      logger.warn(message)
    end
  end
end

log_file_path = "/tmp/codedeploy-agent.update.log"

require 'logger'

if($stdout.isatty)
  # if we are being run in a terminal, log to stdout and the log file.
  @log = LoggerWrapper.new([Logger.new(log_file_path), Logger.new($stdout)])
  @log.level(Logger::INFO)
else
  # keep at most 2MB of old logs rotating out 1MB at a time
  @log = Logger.new(log_file_path, 2, 1048576)
  @log.level = Logger::INFO
  # make sure anything coming out of ruby ends up in the log file
  $stdout.reopen(log_file_path, 'a+')
  $stderr.reopen(log_file_path, 'a+')
end

require 'net/http'

# This class is copied (almost directly) from lib/instance_metadata.rb
# It is not loaded as the InstanceMetadata makes additional assumptions
# about the runtime that cannot be satisfied at install time, hence the
# trimmed copy.
class IMDS
  IP_ADDRESS = '169.254.169.254'
  TOKEN_PATH = '/latest/api/token'
  BASE_PATH = '/latest/meta-data'
  IDENTITY_DOCUMENT_PATH = '/latest/dynamic/instance-identity/document'
  DOMAIN_PATH = '/latest/meta-data/services/domain'

  def self.imds_supported?
    imds_v2? || imds_v1?
  end

  def self.imds_v1?
    begin
      get_request(BASE_PATH) { |response|
        return response.kind_of? Net::HTTPSuccess
      }
    rescue
      false
    end
  end

  def self.imds_v2?
    begin
      put_request(TOKEN_PATH) { |token_response|
        (token_response.kind_of? Net::HTTPSuccess) && get_request(BASE_PATH, token_response.body) { |response|
          return response.kind_of? Net::HTTPSuccess
        }
      }
    rescue
      false
    end
  end

  def self.region
    begin
      identity_document()['region'].strip
    rescue
      nil
    end
  end

  def self.domain
    begin
      get_instance_metadata(DOMAIN_PATH).strip
    rescue
      nil
    end
  end

  def self.identity_document
    # JSON is lazy loaded to ensure we dont break older ruby runtimes
    require 'json'
    JSON.parse(get_instance_metadata(IDENTITY_DOCUMENT_PATH).strip)
  end

  private
  def self.get_instance_metadata(path)
    begin
      token = put_request(TOKEN_PATH)
      get_request(path, token)
    rescue
      get_request(path)
    end
  end


  private
  def self.http_request(request)
    Net::HTTP.start(IP_ADDRESS, 80, :read_timeout => 10, :open_timeout => 10) do |http|
      response = http.request(request)
      if block_given?
        yield(response)
      elsif response.kind_of? Net::HTTPSuccess
        response.body
      else
        raise "HTTP error from metadata service: #{response.message}, code #{response.code}"
      end
    end
  end

  def self.put_request(path, &block)
    request = Net::HTTP::Put.new(path)
    request['X-aws-ec2-metadata-token-ttl-seconds'] = '21600'
    http_request(request, &block)
  end

  def self.get_request(path, token = nil, &block)
    request = Net::HTTP::Get.new(path)
    unless token.nil?
      request['X-aws-ec2-metadata-token'] = token
    end
    http_request(request, &block)
  end
end

class S3Bucket
  # Split out as older versions of ruby dont like multi entry attr
  attr :domain
  attr :region
  attr :bucket
  def initialize(domain, region, bucket)
    @domain = domain
    @region = region
    @bucket = bucket
  end

  def object_uri(object_key)
    URI.parse("https://#{@bucket}.s3.#{@region}.#{@domain}/#{object_key}")
  end
end

begin
  require 'fileutils'
  require 'openssl'
  require 'open-uri'
  require 'uri'
  require 'getoptlong'
  require 'tempfile'

  def usage
    print <<EOF

install [--sanity-check] [--proxy http://hostname:port] <package-type>
   --sanity-check [optional]
   --proxy [optional]
   package-type: 'rpm', 'deb', or 'auto'

Installs fetches the latest package version of the specified type and
installs it. rpms are installed with yum; debs are installed using gdebi.

This program is invoked automatically to update the agent once per day using
the same package manager the codedeploy-agent is initially installed with.

To use this script for a hands free install on any system specify a package
type of 'auto'. This will detect if yum or gdebi is present on the system
and select the one present if possible. If both rpm and deb package managers
are detected the automatic detection will abort
When using the automatic setup, if the system has apt-get but not gdebi,
the gdebi will be installed using apt-get first.

If --sanity-check is specified, the install script will wait for 3 minutes post installation
to check for a running agent.

To use a HTTP proxy, specify --proxy followed by the proxy server
defined by http://hostname:port

This install script needs Ruby versions 2.x or 3.x installed as a prerequisite.
Currently recommended Ruby versions are 2.0.0, 2.1.8, 2.2.4, 2.3, 2.4, 2.5, 2.6, 2.7, 3.0, 3.1, and 3.2
If multiple Ruby versions are installed, the default ruby version will be used.
If the default ruby version does not satisfy requirement, the newest version will be used.
If you do not have a supported Ruby version installed, please install one of them first.

EOF
  end

  def supported_ruby_versions
    ['3.2','3.1','3.0', '2.7', '2.6', '2.5', '2.4', '2.3', '2.2', '2.1', '2.0']
  end

  # check ruby version, only version 2.x 3.x works
  def check_ruby_version_and_symlink
    @log.info("Starting Ruby version check.")
    actual_ruby_version = RUBY_VERSION.split('.').map{|s|s.to_i}[0,2]

    supported_ruby_versions.each do |version|
      if ((actual_ruby_version <=> version.split('.').map{|s|s.to_i}) == 0)
        return File.join(RbConfig::CONFIG["bindir"], RbConfig::CONFIG["RUBY_INSTALL_NAME"] + RbConfig::CONFIG["EXEEXT"])
      end
    end

    supported_ruby_versions.each do |version|
      if(File.exist?("/usr/bin/ruby#{version}"))
        return "/usr/bin/ruby#{version}"
      elsif (File.symlink?("/usr/bin/ruby#{version}"))
        @log.error("The symlink /usr/bin/ruby#{version} exists, but it's linked to a non-existent directory or non-executable file.")
        exit(1)
      end
    end

    unsupported_ruby_version_error
    exit(1)
  end

  def unsupported_ruby_version_error
    @log.error("Current running Ruby version for "+ENV['USER']+" is "+RUBY_VERSION+", but Ruby version 2.x, 3.x needs to be installed.")
    @log.error('If you already have the proper Ruby version installed, please either create a symlink to /usr/bin/ruby2.x,')
    @log.error( "or run this install script with right interpreter. Otherwise please install Ruby 2.x, 3.x for "+ENV['USER']+" user.")
    @log.error('You can get more information by running the script with --help option.')
  end

  def parse_args()
    if (ARGV.length > 4)
      usage
      @log.error('Too many arguments.')
      exit(1)
    elsif (ARGV.length < 1)
      usage
      @log.error('Expected package type as argument.')
      exit(1)
    end

    @sanity_check = false
    @reexeced = false
    @http_proxy = nil
    @target_version_arg = nil

    @args = Array.new(ARGV)
    opts = GetoptLong.new(
      ['--sanity-check', GetoptLong::NO_ARGUMENT],
      ['--help', GetoptLong::NO_ARGUMENT],
      ['--re-execed', GetoptLong::NO_ARGUMENT],
      ['--proxy', GetoptLong::OPTIONAL_ARGUMENT],
      ['-v', '--version', GetoptLong::OPTIONAL_ARGUMENT]
    )
    opts.each do |opt, args|
      case opt
      when '--sanity-check'
        @sanity_check = true
      when '--help'
        usage
        exit(0)
      when '--re-execed'
        @reexeced = true
      when '--proxy'
        if (args != '')
          @http_proxy = args
        end
      when '-v' || '--version'
        @target_version_arg = args
      end
    end
    if (ARGV.length < 1)
      usage
      @log.error('Expected package type as argument.')
      exit(1)
    end
    @type = ARGV.shift.downcase;
  end
  def force_ruby2x(ruby_interpreter_path)
    # change interpreter when symlink /usr/bin/ruby2.x exists, but running with non-supported ruby version
    actual_ruby_version = RUBY_VERSION.split('.').map{|s|s.to_i}
    left_bound = '2.0.0'.split('.').map{|s|s.to_i}
    right_bound = '3.2.1'.split('.').map{|s|s.to_i}
    if (actual_ruby_version <=> left_bound) < 0
      if(!@reexeced)
        @log.info("The current Ruby version is not 2.x or 3.x! Restarting the installer with #{ruby_interpreter_path}")
        exec("#{ruby_interpreter_path}", __FILE__, '--re-execed' , *@args)
      else
        unsupported_ruby_version_error
        exit(1)
      end
    elsif ((actual_ruby_version <=> right_bound) > 0)
      @log.warn("The Ruby version in #{ruby_interpreter_path} is "+RUBY_VERSION+", . Attempting to install anyway.")
    end
  end

  parse_args()

  # Be helpful when 'help' was used but not '--help'
  if @type == 'help'
    usage
    exit(0)
  end

  if (Process.uid != 0)
    @log.error('Must run as root to install packages')
    exit(1)
  end

  ########## Force running as Ruby 2.x or fail here       ##########
  ruby_interpreter_path = check_ruby_version_and_symlink
  force_ruby2x(ruby_interpreter_path)

  def run_command(*args)
    exit_ok = system(*args)
    $stdout.flush
    $stderr.flush
    @log.debug("Exit code: #{$?.exitstatus}")
    return exit_ok
  end

  def get_ec2_metadata_property(property)
    if IMDS.imds_supported?
      begin
        return IMDS.send(property)
      rescue => error
        @log.warn("Could not get #{property} from EC2 metadata service at '#{error.message}'")
      end
    else
      @log.warn("EC2 metadata service unavailable...")
    end
    return nil
  end

  def get_region
    @log.info('Checking AWS_REGION environment variable for region information...')
    region = ENV['AWS_REGION']
    return region if region

    @log.info('Checking EC2 metadata service for region information...')
    region = get_ec2_metadata_property(:region)
    return region if region

    @log.info('Using fail-safe default region: us-east-1')
    return 'us-east-1'
  end

  def get_domain(fallback_region = nil)
    @log.info('Checking AWS_DOMAIN environment variable for domain information...')
    domain = ENV['AWS_DOMAIN']
    return domain if domain

    @log.info('Checking EC2 metadata service for domain information...')
    domain = get_ec2_metadata_property(:domain)
    return domain if domain

    domain = 'amazonaws.com'
    if !fallback_region.nil? && fallback_region.split("-")[0] == 'cn'
      domain = 'amazonaws.com.cn'
    end

    @log.info("Using fail-safe default domain: #{domain}")
    return domain
  end

  def get_package_from_s3(s3_bucket, key, package_file)
    @log.info("Downloading package from bucket #{s3_bucket.bucket} and key #{key}...")

    uri = s3_bucket.object_uri(key)
    @log.info("Endpoint: #{uri}")

    # stream package file to disk
    retries ||= 0
    exceptions = [OpenURI::HTTPError, OpenSSL::SSL::SSLError]
    begin
      uri.open(:ssl_verify_mode => OpenSSL::SSL::VERIFY_PEER, :redirect => true, :read_timeout => 120, :proxy => @http_proxy) do |s3|
        package_file.write(s3.read)
      end
    rescue *exceptions  => e
      @log.warn("Could not find package to download at '#{uri.to_s}' - Retrying... Attempt: '#{retries.to_s}'")
      if (retries < 5)
        sleep 2 ** retries
        retries += 1
        retry
      else
        @log.error("Could not download CodeDeploy Agent Package. Exiting Install script.")
        exit(1)
      end
    end
  end

  def get_version_file_from_s3(s3_bucket, key)
    @log.info("Downloading version file from bucket #{s3_bucket.bucket} and key #{key}...")

    uri = s3_bucket.object_uri(key)
    @log.info("Endpoint: #{uri}")

    retries ||= 0
    exceptions = [OpenURI::HTTPError, OpenSSL::SSL::SSLError, Errno::ETIMEDOUT]
    begin
      require 'json'

      version_string = uri.read(:ssl_verify_mode => OpenSSL::SSL::VERIFY_PEER, :redirect => true, :read_timeout => 120, :proxy => @http_proxy)
      JSON.parse(version_string)
    rescue *exceptions => e
      @log.warn("Could not find version file to download at '#{uri.to_s}' - Retrying... Attempt: '#{retries.to_s}'")
      if (retries < 5)
        sleep 2 ** retries
        retries += 1
        retry
      else
        @log.error("Could not download CodeDeploy Agent version file. Exiting Install script.")
        exit(1)
      end
    end
  end

  def install_from_s3(s3_bucket, package_key, install_cmd)
    package_base_name = File.basename(package_key)
    package_extension = File.extname(package_base_name)
    package_name = File.basename(package_base_name, package_extension)
    package_file = Tempfile.new(["#{package_name}.tmp-", package_extension]) # unique file with 0600 permissions

    get_package_from_s3(s3_bucket, package_key, package_file)
    package_file.close

    install_cmd << package_file.path
    @log.info("Executing `#{install_cmd.join(" ")}`...")

    if (!run_command(*install_cmd))
      @log.error("Error installing #{package_file.path}.")
      package_file.unlink
      exit(1)
    end

    package_file.unlink
  end

  def do_sanity_check(cmd)
    if @sanity_check
      @log.info("Waiting for 3 minutes before I check for a running agent")
      sleep(3 * 60)
      res = run_command(cmd, 'codedeploy-agent', 'status')
      if (res.nil? || res == false)
        @log.info("No codedeploy agent seems to be running. Starting the agent.")
        run_command(cmd, 'codedeploy-agent', 'start-no-update')
      end
    end
  end

  def get_target_version(target_version, type, s3_bucket)
    if target_version.nil?
      version_file_key = 'latest/LATEST_VERSION'
      version_data = get_version_file_from_s3(s3_bucket, version_file_key)
      if version_data.include? type
        return version_data[type]
      else
        @log.error("Unsupported package type '#{type}'")
        exit(1)
      end
    end
    return target_version
  end

  @log.info("Starting update check.")

  if (@type == 'auto')
    @log.info('Attempting to automatically detect supported package manager type for system...')

    has_yum = run_command('which yum >/dev/null 2>/dev/null')
    has_apt_get = run_command('which apt-get >/dev/null 2>/dev/null')
    has_gdebi = run_command('which gdebi >/dev/null 2>/dev/null')
    has_zypper = run_command('which zypper >/dev/null 2>/dev/null')

    if (has_yum && (has_apt_get || has_gdebi))
      @log.error('Detected both supported rpm and deb package managers. Please specify which package type to use manually.')
      exit(1)
    end

    if(has_yum)
      @type = 'rpm'
    elsif(has_zypper)
      @type = 'zypper'
    elsif(has_gdebi)
      @type = 'deb'
    elsif(has_apt_get)
      @type = 'deb'

      @log.warn('apt-get found but no gdebi. Installing gdebi with `apt-get install gdebi-core -y`...')
      #use -y to answer yes to confirmation prompts
      if(!run_command('/usr/bin/apt-get', 'install', 'gdebi-core', '-y'))
        @log.error('Could not install gdebi.')
        exit(1)
      end
    else
      @log.error('Could not detect any supported package managers.')
      exit(1)
    end
  end

  region = get_region()
  domain = get_domain(region)
  bucket = "aws-codedeploy-#{region}"
  s3_bucket = S3Bucket.new(domain, region, bucket)

  target_version = get_target_version(@target_version_arg, @type, s3_bucket)

  case @type
  when 'rpm'
    running_version = `rpm -q codedeploy-agent`
    running_version.strip!
    if target_version.include? running_version
      @log.info('Running version matches target version, skipping install')
    else
      #use -y to answer yes to confirmation prompts
      install_cmd = ['/usr/bin/yum', '-y', 'localinstall']
      install_from_s3(s3_bucket, target_version, install_cmd)
      do_sanity_check('/sbin/service')
    end
  when 'deb'
    running_agent = `dpkg -s codedeploy-agent`
    running_agent_info = running_agent.split
    version_index = running_agent_info.index('Version:')
    if !version_index.nil?
      running_version = running_agent_info[version_index + 1]
    else
      running_version = "No running version"
    end
    @log.info("Running version " + running_version)
    if target_version.include? running_version
      @log.info('Running version matches target version, skipping install')
    else
      #use -n for non-interactive mode
      #use -o to not overwrite config files unless they have not been changed
      install_cmd = ['/usr/bin/gdebi', '-n', '-o', 'Dpkg::Options::=--force-confdef', '-o', 'Dkpg::Options::=--force-confold']
      install_from_s3(s3_bucket, target_version, install_cmd)
      do_sanity_check('/usr/sbin/service')
    end
  when 'zypper'
    #use -n for non-interactive mode
    install_cmd = ['/usr/bin/zypper', 'install', '-n']
    install_from_s3(s3_bucket, target_version, install_cmd)
  else
    @log.error("Unsupported package type '#{@type}'")
    exit(1)
  end

  @log.info("Update check complete.")
  @log.info("Stopping updater.")

rescue SystemExit => e
  # don't log exit() as an error
  raise e
rescue Exception => e
  # make sure all unhandled exceptions are logged to the log
  @log.error("Unhandled exception: #{e.inspect}")
  e.backtrace.each do |line|
    @log.error("  at " + line)
  end
  exit(1)
end
root@ip-172-31-10-193:/home/ubuntu#
